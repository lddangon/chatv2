# Руководство пользователя: Log Viewer

## Обзор

Log Viewer - это компонент серверного GUI ChatV2, который позволяет просматривать логи сервера в реальном времени с возможностью фильтрации, поиска и экспорта.

## Последние улучшения (2026-02-07)

### Что изменилось

Мы значительно улучшили надежность и функциональность Log Viewer:

1. **Улучшенная инициализация** - Logs теперь загружаются надежно даже при проблемах с Log4j2
2. **Fallback механизм** - Если live-логирование недоступно, логи автоматически загружаются из файла
3. **Исправленная фильтрация** - Фильтрация по уровню теперь работает корректно
4. **Чистое отображение** - UI больше не содержит ANSI кодов для лучшей читаемости

## Функции

### 1. Фильтрация по уровню логирования

Log Viewer позволяет фильтровать логи по уровню важности:

| Уровень | Описание | Пример использования |
|---------|----------|---------------------|
| ALL | Все логи | Просмотр полной активности |
| DEBUG | Отладочная информация | Поиск проблем в коде |
| INFO | Информационные сообщения | Общий мониторинг |
| WARN | Предупреждения | Выявление потенциальных проблем |
| ERROR | Ошибки | Поиск и исправление ошибок |

**Как использовать:**
- Выберите нужный уровень из выпадающего списка "Level"
- Логи, соответствующие выбранному уровню и выше, будут отображены

### 2. Поиск по тексту

Вы можете искать конкретные фразы или ключевые слова в логах:

**Как использовать:**
- Введите текст поиска в поле "Search logs..."
- Результаты фильтруются в реальном времени
- Поиск не чувствителен к регистру

### 3. Автоматическая прокрутка

Функция автоматической прокрутки позволяет всегда видеть последние логи:

- ✅ Включена по умолчанию
- Отключите галочку "Auto Scroll" для ручного просмотра истории
- Автоматическая прокрутка сохраняется при фильтрации и поиске

### 4. Очистка логов

Кнопка "Clear" позволяет очистить текущий вид:

- Очищает текстовую область отображения
- Не удаляет логи из файла
- Не останавливает live-логирование

### 5. Обновление логов

Кнопка "Refresh" позволяет:

- Повторно применить текущие фильтры
- Обновить отображение после очистки
- Использовать для принудительного обновления вида

### 6. Экспорт логов

Кнопка "Export" позволяет сохранить текущие логи в файл:

- Экспортирует только отображаемые логи
- Поддерживает формат .txt
- Автоматически генерирует имя файла с датой и временем
- Формат: `chat-server-logs-YYYY-MM-DD-HH-mm-ss.txt`

## Устранение неполадок

### Logs не загружаются

**Симптом:** При открытии Log Viewer пустой

**Возможные причины и решения:**

1. **Live-логирование недоступно**
   - Вы увидите предупреждение: "Live Log Capture Unavailable"
   - Логи автоматически загрузятся из файла (fallback)
   - **Решение:** Это ожидаемое поведение. Логи доступны в режиме чтения из файла

2. **Файл логов не найден**
   - Вы увидите сообщение: "No existing log files found"
   - **Решение:** Проверьте наличие файлов в директориях:
     - `logs/chat-server.log`
     - `logs/application.log`
     - `logs/server.log`

3. **Нет доступа к файлу логов**
   - **Решение:** Убедитесь, что файлы имеют права на чтение

### Фильтрация работает некорректно

**Симптом:** Логи не фильтруются по уровню

**Возможные причины:**

1. **Выбран уровень ALL**
   - **Решение:** Выберите конкретный уровень (DEBUG, INFO, WARN, ERROR)

2. **Формат логов не содержит уровень**
   - **Решение:** Убедитесь, что конфигурация логирования использует стандартный формат

### ANSI коды в UI

**Симптом:** Видны странные символы типа `[31m` или `[0m`

**Решение:**
- Эта проблема была исправлена в версии 2026-02-07
- Обновитесь до последней версии
- Если проблема сохраняется, убедитесь, что используете Log4j2 2.23.1+

## Архитектура и технические детали

### Как работает Log Viewer

```
┌─────────────────────────────────────────────────────────────┐
│                     LogViewerController                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐         ┌─────────────────┐          │
│  │  UI Components  │◄───────►│  Log Buffer     │          │
│  │  (TextArea,     │         │  (Concurrent)   │          │
│  │   ComboBox,     │         │                 │          │
│  │   TextField)    │         └────────┬────────┘          │
│  └─────────────────┘                  │                   │
│                                      │                     │
│                                      │                     │
│                          ┌───────────┴───────────┐        │
│                          │                       │        │
│                          ▼                       │        │
│                 ┌─────────────────┐             │        │
│                 │  Log4j2 Appender│             │        │
│                 │  (Async)        │             │        │
│                 └─────────────────┘             │        │
│                          │                       │        │
│                          │                       │        │
│                          ▼                       ▼        │
│                 ┌─────────────────┐   ┌─────────────────┐│
│                 │  Live Logs      │   │  File Fallback  ││
│                 │  (Real-time)    │   │  (Read file)    ││
│                 └─────────────────┘   └─────────────────┘│
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Ключевые компоненты

1. **LogViewerController** - главный контроллер
   - Управляет UI компонентами
   - Обрабатывает события пользователя
   - Фильтрует логи

2. **LogAppender** - пользовательский Log4j2 appender
   - Перехватывает события логирования
   - Форматирует логи для отображения
   - Фильтрует по уровню
   - Обновляет UI через Platform.runLater()

3. **Log Buffer** - потокобезопасный буфер
   - Хранит последние 1000 логов
   - Используется для фильтрации
   - Содержит только plain text без ANSI кодов

### Асинхронная инициализация

Log Viewer использует асинхронную инициализацию для предотвращения блокировки UI:

```
UI Thread               Background Thread
─────────               ─────────────────
│                       │
│ Initialize            │ Start async init
│   ↓                   │
│ UI Components         │ Delay 500ms
│   ↓                   │
│ Show View             │ Retry setup (3x)
│                       │   ↓
│                       │ Fallback to file
│                       │
◄──────────────────────┤ Update UI with logs
```

## Конфигурация

### Расположение лог-файлов

Log Viewer ищет лог-файлы в следующих директориях (в порядке приоритета):

1. `logs/chat-server.log` (приоритет)
2. `logs/application.log`
3. `logs/server.log`
4. `{user.dir}/logs/chat-server.log`
5. `{user.dir}/logs/application.log`

### Настройка Log4j2

Конфигурация Log4j2 находится в `chat-common/src/main/resources/logback.xml`:

```xml
<configuration>
    <appender name="FILE_SERVER" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/server.log</file>
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <expression>logger.startsWith("com.chatv2.server") || 
                        logger.startsWith("com.chatv2.launcher.server")</expression>
        </filter>
    </appender>
</configuration>
```

## FAQ

**Q: Почему live-логирование недоступно?**
A: Это может произойти при проблемах с инициализацией Log4j2. Log Viewer автоматически переключится на чтение из файла.

**Q: Сколько логов хранится в буфере?**
A: По умолчанию 1000 последних записей. Это можно изменить в коде через константу `MAX_LOG_ENTRIES`.

**Q: Можно ли изменить формат отображения логов?**
A: Формат определен в Log4j2 конфигурации. Измените паттерн в logback.xml.

**Q: Как увеличить количество попыток инициализации appender?**
A: Измените константу `APPENDER_INIT_RETRY_COUNT` в LogViewerController.java.

**Q: Поддерживаются ли цвета в экспортированных файлах?**
A: Текущая версия экспортирует plain text. ANSI коды доступны только для будущего расширения функциональности.

## Поддержка

Если у вас возникли проблемы с Log Viewer:

1. Проверьте логи в `logs/server.log`
2. Убедитесь, что Log Viewer загружается корректно (нет ошибок в консоли)
3. Проверьте права доступа к файлам логов
4. Убедитесь, что используете актуальную версию ChatV2 (2026-02-07+)

## Дополнительные ресурсы

- [CHANGELOG.md](CHANGELOG.md) - История изменений
- [GUI_Fixes_Test_Report.md](GUI_Fixes_Test_Report.md) - Технический отчет об исправлениях
- [README.md](../README.md) - Общая документация проекта
