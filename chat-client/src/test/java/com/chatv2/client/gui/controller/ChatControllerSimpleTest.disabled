package com.chatv2.client.gui.controller;

import com.chatv2.client.core.ChatClient;
import com.chatv2.client.gui.ChatClientApp;
import com.chatv2.common.model.Message;
import com.chatv2.common.model.MessageType;
import com.chatv2.common.model.UserProfile;
import com.chatv2.common.model.UserStatus;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.scene.layout.HBox;
import javafx.scene.shape.Circle;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.testfx.framework.junit5.ApplicationExtension;
import org.testfx.util.WaitForAsyncUtils;

import java.util.UUID;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * Simple unit tests for ChatController class.
 */
@ExtendWith({ApplicationExtension.class, MockitoExtension.class})
public class ChatControllerSimpleTest {

    @Mock
    private ChatClient mockChatClient;

    @Mock
    private ChatClientApp mockChatClientApp;

    private ChatController chatController;
    private MockedStatic<ChatClientApp> mockedApp;

    @BeforeEach
    public void setUp() throws Exception {
        // Initialize JavaFX toolkit for testing
        try {
            CountDownLatch latch = new CountDownLatch(1);
            Platform.startup(() -> latch.countDown());
            assertTrue(latch.await(5, TimeUnit.SECONDS), "JavaFX platform should be initialized");
        } catch (IllegalStateException e) {
            // Toolkit already initialized, which is fine
            if (!e.getMessage().contains("Toolkit already initialized")) {
                throw e;
            }
        }

        // Create ChatController instance
        chatController = new ChatController();
        
        // Mock the FXML fields using reflection
        try {
            var chatListViewField = chatController.getClass().getDeclaredField("chatListView");
            chatListViewField.setAccessible(true);
            chatListViewField.set(chatController, new ListView<>());
            
            var participantsListViewField = chatController.getClass().getDeclaredField("participantsListView");
            participantsListViewField.setAccessible(true);
            participantsListViewField.set(chatController, new ListView<>());
            
            var messageVBoxField = chatController.getClass().getDeclaredField("messageVBox");
            messageVBoxField.setAccessible(true);
            messageVBoxField.set(chatController, new VBox());
            
            var messageScrollPaneField = chatController.getClass().getDeclaredField("messageScrollPane");
            messageScrollPaneField.setAccessible(true);
            messageScrollPaneField.set(chatController, new ScrollPane());
            
            var messageTextAreaField = chatController.getClass().getDeclaredField("messageTextArea");
            messageTextAreaField.setAccessible(true);
            messageTextAreaField.set(chatController, new TextArea());
            
            var sendButtonField = chatController.getClass().getDeclaredField("sendButton");
            sendButtonField.setAccessible(true);
            sendButtonField.set(chatController, new Button());
            
            var attachButtonField = chatController.getClass().getDeclaredField("attachButton");
            attachButtonField.setAccessible(true);
            attachButtonField.set(chatController, new Button());
            
            var logoutButtonField = chatController.getClass().getDeclaredField("logoutButton");
            logoutButtonField.setAccessible(true);
            logoutButtonField.set(chatController, new Button());
            
            var profileButtonField = chatController.getClass().getDeclaredField("profileButton");
            profileButtonField.setAccessible(true);
            profileButtonField.set(chatController, new Button());
            
            var currentChatLabelField = chatController.getClass().getDeclaredField("currentChatLabel");
            currentChatLabelField.setAccessible(true);
            currentChatLabelField.set(chatController, new Label());
        } catch (Exception e) {
            throw new RuntimeException("Failed to initialize FXML fields", e);
        }
        
        // Mock ChatClientApp.getInstance() for the entire test class
        mockedApp = mockStatic(ChatClientApp.class);
        mockedApp.when(ChatClientApp::getInstance).thenReturn(mockChatClientApp);
        when(mockChatClientApp.getChatClient()).thenReturn(mockChatClient);
        
        // Initialize the controller
        chatController.initialize(null, null);
    }

    @Test
    public void testInitialization() {
        // Verify that the controller initializes properly
        assertNotNull(chatController);
        verify(mockChatClient).registerMessageConsumer(any());
    }

    @Test
    public void testJavaFXComponentsImport() {
        // This test verifies that JavaFX components are properly imported and can be instantiated
        VBox vBox = new VBox();
        HBox hBox = new HBox();
        Circle circle = new Circle();
        
        assertNotNull(vBox, "VBox should be created successfully");
        assertNotNull(hBox, "HBox should be created successfully");
        assertNotNull(circle, "Circle should be created successfully");
    }

    @AfterEach
    public void tearDown() {
        if (mockedApp != null) {
            mockedApp.close();
        }
    }
}